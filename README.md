# Измеритель расстояния на STM32 с HY-SRF05, LCD1602 и PWM-индикацией

Проект реализует **измеритель расстояния** на базе ультразвукового датчика **HY-SRF05** и микроконтроллера **STM32F103C8T6 (Blue Pill)**.  
Расстояние отображается на **LCD1602** (через расширитель **PCF8574 по I²C**), а также используется **светодиодная и звуковая индикация на PWM**.

- [Электрическая принципиальная схема](./docs/ElectricalSchematicDiagram.png)
- [Конфигурация в CubeMX](./docs/CubeMX.jpg)
- [Подключение ST-LINK V2](./docs/STLinkV2.jpg)
- [Видеодемонстрация](https://youtube.com/shorts/hrjaTZsLUqA?feature=share)

---

Основные компоненты:

- **STM32F103C8T6** — микроконтроллер (аналог Blue Pill).
- **HY-SRF05 (5 V)** — ультразвуковой датчик расстояния.
- **LCD1602 + PCF8574 (5 V, I²C)** — текстовый дисплей.
- **4× LED + резисторы** — индикация расстояния.
- **Buzzer** — звуковая индикация.
- **ST-LINK V2** — отладка и прошивка по SWD.

---
## Программная часть

**Структура проекта**

```
stm32f1_hysrf05_lcd_pwm_hal/
├── Core/                     # Исходники и заголовки проекта
│   ├── Inc/                  # Заголовочные файлы (.h)
│   └── Src/                  # Исходные файлы (.c)
├── Drivers/                  # Драйверы STM32 HAL
├── docs/                     # Схемы, скриншоты CubeMX и пр.
├── HY-SRF05_LCD1602_HAL.ioc  # Файл конфигурации STM32CubeMX
└── README.md                 # Документация (этот файл)
```
- `main.c` — инициализация HAL, тактирования (72 МГц), GPIO, I²C1, TIM2/3, USART1; основной цикл, логика измерения и индикации.
- `lcd1602_i2c_lib.c` — работа с LCD1602 через PCF8574 (4-битный режим по I²C).
- `i2c.c`, `tim.c`, `gpio.c`, `usart.c` — код, сгенерированный CubeMX с небольшими правками.
- Используется блок **DWT (Data Watchpoint and Trace)** для `DWT_Delay_us()` с микросекундной точностью.

## Алгоритм работы

1. **Инициализация**  
   Настройка тактирования (72 МГц), GPIO, I²C1, TIM2/3 (PWM), UART1, DWT, LCD1602. Запуск PWM на TIM2/TIM3.

2. **Измерение расстояния (HY-SRF05)**  
   - Формируется импульс TRIG 10 мкс.  
   - На ECHO измеряется длительность высокого уровня с помощью DWT-счётчика.  
   - По времени рассчитывается расстояние в см (с учётом скорости звука и пути туда-обратно).

3. **Индикация**  
   - Каждые ~400 мс обновляется строка на LCD вида `XX.XX cm`.  
   - В зависимости от расстояния задаются скважности PWM:
     - при больших расстояниях — светодиоды и буззер выключены;
     - по мере приближения последовательно загораются 4 LED (TIM3 CH1–CH4) и растёт скважность буззера (TIM2 CH1).
   - Все значения duty cycle пишутся через `__HAL_TIM_SET_COMPARE()`.

| Расстояние (см) | Светодиоды     | PWM зуммера          |
|-----------------|----------------|----------------------|
| > 40            | Все выключены  | Без звука            |
| 30–40           | LED1           | 30 / 1000 (низкий)   |
| 20–30           | LED2           | 150 / 1000 (средний) |
| 10–20           | LED3           | 300 / 1000 (высокий) |
| 0–10            | LED4           | 700 / 1000 (максимум)|

---
## Аппаратная часть

Описание схемы:
- HY-SRF05 питается от **5 V**, вывод **ECHO** через делитель уровня R1/R2 подаётся на вход STM32 (≈3.0–3.3 V).
- STM32 питается от **3.3 V**, на каждой паре VDD/VSS стоят по **100 нФ**, плюс один **10 µФ** на шине.
- LCD и PCF8574 работают от **5 V**, подключены по **I²C1 (PB6/PB7)**; на SCL/SDA стоят внешние pull-up к 5 V.
- SWD (PA13/PA14, NRST, 3V3, GND) выведен на отдельный разъём под ST-LINK.
- **BOOT0** подтянут к GND (10 kΩ), **NRST** — к 3.3 V (10 kΩ + 100 нФ + кнопка).

По схеме видно, что:
- У HY-SRF05 есть локальный конденсатор **C0 100 nF** между VCC и GND.  
- Вывод **ECHO** через делитель **R1/R2** преобразуется с 5 V до уровня ~3.3 V для входа STM32.  
- В обвязке МК стоят по одному конденсатору **100 nF** на каждую пару VDD/VSS (**C1–C4**) и общий электролит **C5 10 µF** на линии 3.3 V.  

## Подключение: пользовательские сигналы (GPIO → внешние узлы)

| Назначение        | Порт STM32      | Примечание                               |
|-------------------|-----------------|------------------------------------------|
| TRIG HY-SRF05     | PA0             | Выход на TRIG датчика                    |
| ECHO HY-SRF05     | PA1             | Вход с ECHO (через делитель R1/R2)       |
| I²C1 — SCL        | PB6             | Линия SCL к PCF8574                      |
| I²C1 — SDA        | PB7             | Линия SDA к PCF8574                      |
| LED 1             | PA6 (TIM3_CH1)  | Ближний светодиод                        |
| LED 2             | PA7 (TIM3_CH2)  |                                          |
| LED 3             | PB0 (TIM3_CH3)  |                                          |
| LED 4             | PB1 (TIM3_CH4)  | Дальний светодиод                        |
| Buzzer            | PA15 (TIM2_CH1) | Управление зуммером                      |

---

## Служебные и отладочные линии

Эти сигналы обычному пользователю достаточно подключить к разъёму SWD, но здесь они приведены для полноты и переноса проекта на другие платы.

| Назначение      | Порт / вывод | Примечание                                        |
|-----------------|--------------|---------------------------------------------------|
| SWDIO           | PA13         | Линия данных SWD (ST-LINK V2)                    |
| SWCLK           | PA14         | Линия тактирования SWD                           |
| NRST            | NRST pin     | Общий ресет МК и ST-LINK; выведен на разъём J2   |
| 3V3 (VREF)      | — / J2 pin   | Питание логики и опорное напряжение для ST-LINK |
| GND             | — / J2 pin   | Общий «земляной» провод                          |
| BOOT0           | BOOT0 pin    | Режим загрузки, подтянут к GND через R10 10 kΩ   |

---

## Конфигурация периферии в STM32CubeMX

| Периферия | Настройки                                     |
|-----------|-----------------------------------------------|
| **I²C1**  | SDA — PB7, SCL — PB6; режим I²C; 100 кГц      |
| **TIM2**  | CH1 — PA15; режим PWM Generation CH1 (зуммер) |
| **TIM3**  | CH1 — PA6, CH2 — PA7, CH3 — PB0, CH4 — PB1; режим PWM Generation CH1–CH4 (LED) |
| **GPIO**  | TRIG: PA0 — выход (Push-Pull)                 |
|           | ECHO: PA1 — вход (Pull-down)                  |

---

## Сборка и запуск

Откройте файл HY-SRF05_LCD1602_HAL.ioc в STM32CubeIDE.

Сгенерируйте и соберите проект (Ctrl + B).

Прошейте устройство через ST-LINK V2.

Подключите датчик, LCD-модуль, светодиоды и зуммер согласно таблице и схеме.

Наблюдайте результат на экране, по светодиодам и звуку.
